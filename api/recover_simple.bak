<?php
/**
 * API simplificada para recuperar contraseña
 */

// Habilitar registro de errores
ini_set('display_errors', 1);
ini_set('log_errors', 1);
error_reporting(E_ALL);

// Cargar el autoloader de Composer para SendGrid
ob_start();
require __DIR__ . '/../vendor/autoload.php';
ob_end_clean();

// Configuración de cabeceras CORS
header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS');
header('Access-Control-Allow-Headers: Origin, Content-Type, Authorization, X-Requested-With');
header('Content-Type: application/json');

// Si es una solicitud OPTIONS, terminar aquí (preflight CORS)
if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
    http_response_code(200);
    exit(0);
}

// Crear directorio de logs si no existe
$log_dir = __DIR__ . '/../logs';
if (!is_dir($log_dir)) {
    mkdir($log_dir, 0777, true);
}

// Función para registrar mensajes de depuración
function debug_log($message) {
    $log_file = __DIR__ . '/../logs/debug.log';
    $timestamp = date('Y-m-d H:i:s');
    $log_message = "[$timestamp] $message" . PHP_EOL;
    file_put_contents($log_file, $log_message, FILE_APPEND);
}

// Función para generar una contraseña aleatoria
function generarPassword($longitud = 8) {
    $caracteres = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ!@#$%^&*()';
    $password = '';
    $max = strlen($caracteres) - 1;
    
    for ($i = 0; $i < $longitud; $i++) {
        $password .= $caracteres[random_int(0, $max)];
    }
    
    return $password;
}

// Función para enviar correo con la nueva contraseña
function enviarPasswordPorCorreo($email, $password) {
    debug_log("Preparando envío de correo a: $email");
    
    try {
        // Crear el objeto de correo
        $email_obj = new \SendGrid\Mail\Mail();
        $email_obj->setFrom("shmarte@gmail.com", "Sistema de Recuperación de Contraseña");
        $email_obj->setSubject("Recuperación de Contraseña - " . date("Y-m-d H:i:s"));  
        $email_obj->addTo($email, "Usuario");
        
        // Contenido del correo
        $contenido_texto = "Su nueva contraseña temporal es: $password\n\n";
        $contenido_texto .= "Por favor, cambie esta contraseña después de iniciar sesión por motivos de seguridad.";
        
        $contenido_html = "<h2>Recuperación de Contraseña</h2>";
        $contenido_html .= "<p>Su nueva contraseña temporal es: <strong>$password</strong></p>";
        $contenido_html .= "<p>Por favor, cambie esta contraseña después de iniciar sesión por motivos de seguridad.</p>";
        
        $email_obj->addContent("text/plain", $contenido_texto);
        $email_obj->addContent("text/html", $contenido_html);
        
        $sendgrid = new \SendGrid('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');
        
        // Configurar el cliente para ignorar la verificación SSL si es necesario
        $sendgrid->client->setCurlOptions([
            CURLOPT_CAINFO => 'C:/cert/cacert.pem',
            CURLOPT_SSL_VERIFYPEER => false,
            CURLOPT_SSL_VERIFYHOST => false
        ]);
        
        debug_log("Enviando correo a través de SendGrid...");
        $response = $sendgrid->send($email_obj);
        debug_log("Respuesta del envío de correo: Código " . $response->statusCode());
        
        return [
            'success' => $response->statusCode() >= 200 && $response->statusCode() < 300,
            'status_code' => $response->statusCode(),
            'message' => $response->body()
        ];
    } catch (Exception $e) {
        debug_log("Error al enviar correo con SendGrid: " . $e->getMessage());
        return [
            'success' => false,
            'message' => $e->getMessage()
        ];
    }
}

// Registrar inicio de la solicitud
debug_log("=== NUEVA SOLICITUD SIMPLE ===");
debug_log("Método HTTP: " . $_SERVER['REQUEST_METHOD']);

// Incluir archivos necesarios
require_once __DIR__ . '/../config/conexion.php';

// Verificar que sea una petición POST
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    debug_log("Procesando solicitud POST");
    
    // Obtener el correo electrónico
    $input = file_get_contents("php://input");
    debug_log("Datos recibidos: " . $input);
    
    // Verificar si los datos son JSON válido
    $data = json_decode($input);
    if (json_last_error() !== JSON_ERROR_NONE) {
        debug_log("Error al decodificar JSON: " . json_last_error_msg());
        http_response_code(400);
        echo json_encode([
            'status' => 'error',
            'message' => 'Formato de datos inválido: ' . json_last_error_msg()
        ]);
        exit;
    }
    
    // Verificar si se proporcionó un email
    if (empty($data->email)) {
        debug_log("No se proporcionó un correo electrónico");
        http_response_code(400);
        echo json_encode([
            'status' => 'error',
            'message' => 'No se proporcionó un correo electrónico'
        ]);
        exit;
    }
    
    debug_log("Email recibido: " . $data->email);
    
    try {
        // Inicializar la conexión a la base de datos
        $database = new Conexion();
        debug_log("Conexión a la base de datos inicializada");
        
        // Verificar si el email existe en la base de datos
        $sql = "SELECT idUser, emailUser FROM agusers WHERE emailUser = ?";
        debug_log("Verificando si el email existe: " . $sql);
        
        $user = $database->getRow($sql, [$data->email]);
        
        if (!$user) {
            debug_log("El email no existe en la base de datos");
            http_response_code(404);
            echo json_encode([
                'status' => 'error',
                'message' => 'Este correo electrónico no está registrado en nuestro sistema.'
            ]);
            exit;
        }
        
        debug_log("Usuario encontrado: ID=" . $user['idUser']);
        
        // Generar nueva contraseña
        $newPassword = generarPassword(10);
        debug_log("Nueva contraseña generada");
        
        // Hashear la contraseña para almacenarla en la base de datos
        $hashedPassword = password_hash($newPassword, PASSWORD_DEFAULT);
        debug_log("Contraseña hasheada");
        
        // Actualizar la contraseña del usuario
        $updateSql = "UPDATE agusers SET passwordUser = ? WHERE idUser = ?";
        debug_log("Actualizando contraseña: " . $updateSql);
        
        $database->query($updateSql, [$hashedPassword, $user['idUser']]);
        debug_log("Contraseña actualizada en la base de datos");
        
        // Registrar la solicitud de recuperación
        $currentDate = date('Y-m-d H:i:s');
        $sql = "INSERT INTO agrecuperacion (emailrecuperacion, daterecuperacion) VALUES (?, ?)";
        debug_log("Registrando solicitud: " . $sql);
        
        $stmt = $database->query($sql, [$data->email, $currentDate]);
        $recoveryId = $database->getConnection()->lastInsertId();
        debug_log("Solicitud registrada: ID=" . ($recoveryId ? $recoveryId : 'Error'));
        
        // Enviar la nueva contraseña por correo electrónico
        $emailResult = enviarPasswordPorCorreo($data->email, $newPassword);
        debug_log("Resultado del envío de correo: " . json_encode($emailResult));
        
        if ($emailResult['success']) {
            // Éxito al enviar el correo
            http_response_code(200);
            $response = [
                'status' => 'success',
                'message' => 'Se ha enviado una nueva contraseña a tu correo electrónico.',
                'id' => $recoveryId
            ];
            debug_log("Respuesta de éxito: " . json_encode($response));
            echo json_encode($response);
        } else {
            // Error al enviar el correo, pero la contraseña se actualizó
            http_response_code(200);
            $response = [
                'status' => 'warning',
                'message' => 'Se ha generado una nueva contraseña, pero hubo un problema al enviar el correo. Por favor, contacta con soporte.',
                'id' => $recoveryId
            ];
            debug_log("Respuesta de advertencia: " . json_encode($response));
            echo json_encode($response);
        }
    } catch (Exception $e) {
        // Error al procesar la solicitud
        $errorMsg = $e->getMessage();
        debug_log("Excepción: " . $errorMsg);
        
        http_response_code(500);
        $response = [
            'status' => 'error',
            'message' => 'Error al procesar la solicitud: ' . $errorMsg
        ];
        debug_log("Respuesta de error (excepción): " . json_encode($response));
        echo json_encode($response);
    }
} else {
    // Método no permitido
    http_response_code(405);
    $response = [
        'status' => 'error',
        'message' => 'Método no permitido'
    ];
    debug_log("Método no permitido: " . $_SERVER['REQUEST_METHOD']);
    echo json_encode($response);
}

debug_log("Fin de la solicitud");
?>